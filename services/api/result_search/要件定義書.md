# result_search機能 要件定義書

## 1. 概要
対戦結果をデータベースに保存し、プロフィール画面でユーザーの戦績を表示する機能を提供します。
pong2（2人対戦）とpong42（42人固定対戦）の対戦結果を管理し、ユーザーのゲーム履歴と統計情報を提供します。

## 2. 目的
- 対戦結果をリアルタイムでデータベースに保存
- プロフィール画面でユーザーの戦績履歴を表示
- pong2（2人対戦）とpong42（42人対戦）の結果を分離して管理
- ユーザーの成長やパフォーマンスを把握可能にする

## 3. 機能要件

### 3.1 対戦結果保存機能
- **pong2対戦結果**の保存
  - 対戦日時
  - 対戦相手のユーザー名
  - 勝敗（win/lose）
- **pong42対戦結果**の保存
  - 対戦日時
  - 順位（1-42位）

### 3.2 対戦結果取得機能
- 指定ユーザーのpong2対戦履歴取得
- 指定ユーザーのpong42対戦履歴取得
- ユーザー統計情報の取得（勝率、総試合数、平均順位など）

## 4. データベース設計

### 4.1 テーブル構造

#### game_results_pong2 (2人対戦結果)
```sql
CREATE TABLE game_results_pong2 (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  username TEXT NOT NULL,
  opponent_username TEXT NOT NULL,
  result TEXT NOT NULL CHECK(result IN ('win', 'lose')),
  game_date DATETIME NOT NULL
);

CREATE INDEX idx_pong2_username_date ON game_results_pong2(username, game_date);
```

#### game_results_pong42 (42人対戦結果)
```sql
CREATE TABLE game_results_pong42 (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  username TEXT NOT NULL,
  rank INTEGER NOT NULL CHECK(rank >= 1 AND rank <= 42),
  game_date DATETIME NOT NULL
);

CREATE INDEX idx_pong42_username_date ON game_results_pong42(username, game_date);
```

## 5. API設計

### 5.1 エンドポイント

#### GET /api/results/pong2/:username
- **目的**: 指定ユーザーのpong2対戦結果一覧を取得
- **パラメータ**: 
  - username: ユーザー名 (path parameter)
  - limit?: 取得件数制限 (query parameter, default: 10)
  - offset?: オフセット (query parameter, default: 0)
- **認証**: JWT トークン必須
- **レスポンス**: Pong2Result[]

#### GET /api/results/pong42/:username
- **目的**: 指定ユーザーのpong42対戦結果一覧を取得
- **パラメータ**: 
  - username: ユーザー名 (path parameter)
  - limit?: 取得件数制限 (query parameter, default: 10)
  - offset?: オフセット (query parameter, default: 0)
- **認証**: JWT トークン必須
- **レスポンス**: Pong42Result[]

#### POST /api/results/pong2
- **目的**: pong2対戦結果を登録
- **認証**: JWT トークン必須
- **リクエストボディ**:
```json
{
  "username": "string",
  "opponentUsername": "string",
  "result": "win" | "lose",
  "gameDate": "2024-01-15T14:30:00Z"
}
```

#### POST /api/results/pong42
- **目的**: pong42対戦結果を登録
- **認証**: JWT トークン必須
- **リクエストボディ**:
```json
{
  "username": "string",
  "rank": 1-42,
  "gameDate": "2024-01-20T19:00:00Z"
}
```

#### GET /api/results/stats/:username
- **目的**: ユーザーの統計情報を取得
- **パラメータ**: username: ユーザー名 (path parameter)
- **認証**: JWT トークン必須
- **レスポンス**: UserStats

### 5.2 レスポンス形式

#### Pong2Result
```typescript
interface Pong2Result {
  id: number;
  username: string;
  opponentUsername: string;
  result: 'win' | 'lose';
  gameDate: string;
}
```

#### Pong42Result
```typescript
interface Pong42Result {
  id: number;
  username: string;
  rank: number;
  gameDate: string;
}
```

#### UserStats
```typescript
interface UserStats {
  username: string;
  pong2Stats: {
    totalGames: number;
    wins: number;
    losses: number;
    winRate: number;
    recentGames: Pong2Result[];
  };
  pong42Stats: {
    totalGames: number;
    bestRank: number;
    averageRank: number;
    recentGames: Pong42Result[];
  };
}
```

#### APIResponse
```typescript
interface APIResponse<T> {
  success: boolean;
  data: T;
  message?: string;
  error?: string;
  timestamp: string;
}
```

## 6. 技術要件

### 6.1 使用技術
- **データベース**: SQLite (Prisma ORM使用)
- **フレームワーク**: NestJS + Fastify
- **言語**: TypeScript
- **認証**: JWT トークン (@nestjs/jwt)
- **バリデーション**: class-validator, class-transformer
- **コンテナ**: Docker
- **ポート**: 3003

### 6.2 ディレクトリ構造
```
services/api/result_search/
├── Dockerfile
├── nest-cli.json
├── package.json
├── tsconfig.json
├── prisma/
│   ├── schema.prisma
│   └── seed.ts
└── srcs/
    ├── app.module.ts
    ├── main.ts
    ├── prisma.service.ts
    ├── auth/
    │   ├── auth.guard.ts
    │   └── jwt.strategy.ts
    └── result-search/
        ├── result-search.controller.ts
        ├── result-search.service.ts
        ├── result-search.module.ts
        └── dto/
            ├── create-pong2-result.dto.ts
            ├── create-pong42-result.dto.ts
            └── query-results.dto.ts
```

## 7. セキュリティ要件
- JWT トークンによる認証
- 入力データのバリデーション（class-validator使用）
- SQLインジェクション対策（Prisma使用）
- CORS設定
- エラー情報の適切なマスキング

## 8. パフォーマンス要件
- APIレスポンス時間: 500ms以下
- データベースクエリの最適化
- インデックス設定（username, gameDate）
- ページネーション実装
- 適切なキャッシュ戦略

## 9. エラーハンドリング

### 9.1 エラーコード定義
- **400 Bad Request**: 不正なリクエストパラメータ
- **401 Unauthorized**: JWT認証失敗
- **403 Forbidden**: 権限不足
- **404 Not Found**: 指定されたリソースが存在しない
- **422 Unprocessable Entity**: バリデーション失敗
- **500 Internal Server Error**: サーバー内部エラー

### 9.2 エラーレスポンス形式
```typescript
interface ErrorResponse {
  success: false;
  error: string;
  message: string;
  details?: any;
  timestamp: string;
}
```

## 10. 環境変数

```bash
# データベース
DATABASE_URL="file:./dev.db"

# JWT
JWT_SECRET="your-secret-key"
JWT_EXPIRES_IN="24h"

# サーバー設定
PORT=3003
NODE_ENV="development"

# CORS設定
FRONTEND_URL="http://localhost:3000"

# ログ設定
LOG_LEVEL="info"
```

## 11. 実装手順

### Phase 1: 基盤セットアップ
1. プロジェクト初期化（package.json, tsconfig.json, nest-cli.json）
2. NestJSアプリケーション設定
3. Prismaスキーマ定義
4. Docker設定
5. Fastifyアダプター設定

### Phase 2: データベース実装
1. Prismaマイグレーション作成・実行
2. シードデータ作成・投入
3. PrismaService作成
4. データベース接続確認

### Phase 3: 認証・セキュリティ実装
1. JWT Strategy実装
2. Auth Guard作成
3. パスポート設定

### Phase 4: API実装
1. DTO定義作成
2. Result Search Service実装
3. Result Search Controller実装
4. Result Search Module作成
5. App Module統合

### Phase 5: テスト・検証
1. ユニットテスト作成
2. 統合テスト実行
3. API動作確認
4. パフォーマンステスト

### Phase 6: デプロイ準備
1. Docker環境での動作確認
2. 環境変数の設定
3. ログ設定
4. 監視設定

## 12. 成功基準
- ✅ pong2対戦結果の保存・取得が正常に動作する
- ✅ pong42対戦結果の保存・取得が正常に動作する
- ✅ ユーザー統計情報が正確に計算される
- ✅ JWT認証が正常に機能する
- ✅ APIレスポンス時間が500ms以下を維持
- ✅ データベースのパフォーマンスが良好
- ✅ フロントエンドとの連携が正常に動作する
- ✅ エラーハンドリングが適切に実装される
- ✅ 全てのテストケースが成功する

## 13. 運用要件
- ログの適切な出力と監視
- データベースの定期バックアップ
- パフォーマンス監視
- セキュリティアップデートの適用
- 障害発生時の対応手順